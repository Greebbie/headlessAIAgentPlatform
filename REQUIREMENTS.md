# HlAB - 核心需求文档

## 一、项目定位

面向国产传统行业/政企的 **Headless AI Agent Chatbot 框架**。
- 本质: "框架壳 (Agent Runtime)" — 客户在上面配置不同 Agent
- 能力: 对话 + 办事 + 工具调用
- 部署: 私有化部署优先, 本地模型优先, 合规可审计
- 接入: 客户已有业务系统通过标准 API/SDK 接入
- 运营: Web 可视化控制台进行配置与运营

---

## 二、核心需求清单

### 需求 1: Agent 与办事流程可定制 (最高优先级)

| 子项 | 描述 |
|------|------|
| 流程可配置 | 每个事项有独立步骤流转: 收集字段→校验→上传材料→生成表单→调用后端→返回结果/进度→转人工 |
| 步骤配置 | 每步定义: 提示语、表单字段、校验规则、绑定工具、失败回退策略、人机协同点 |
| 零代码为主 | 通过可视化配置 (流程编排/步骤配置/字段配置/工具勾选) 落地, 无需写代码 |
| 高级扩展 | 提供插件/SDK 扩展点供复杂场景使用 |
| 字段类型 | 支持: text/number/date/phone/id_card/file/select/multi_select/address/custom |
| 校验规则 | 内置 + 正则 + 自定义函数 |

### 需求 2: 对话体验 — 短答优先 + 推荐追问

| 子项 | 描述 |
|------|------|
| 默认输出 | `short_answer` (1-2行精准) + `citations` (引用) + `suggested_followups` (推荐追问) |
| 展开模式 | 用户明确要求详细/展开/完整流程时, 给 `expanded_answer` 或下一步引导 |
| 流式输出 | 先快给核心答案, 再补引用/追问/步骤卡片 |
| 分段渲染 | 支持前端分段渲染: answer → citations → followups → cards |

### 需求 3: 知识与检索 — 高性能不全库遍历

| 子项 | 描述 |
|------|------|
| 知识上传 | 支持文档(PDF/Word/Excel)、FAQ、结构化表, 自动处理入库 |
| 引用追溯 | 引用精确到页码/段落/行号 |
| 快答通道 | 事实查询(电话/地址/时间/联系人)优先走 KV/实体表/FAQ, 延迟 <50ms |
| 标准RAG | 混合检索(倒排+向量+rerank), 严格 top-k, 索引分片/按知识域隔离 |
| 缓存 | 热点查询缓存, 异步索引构建, 增量更新 |
| 无引用兜底 | 无法确认时输出: "无法确认/需要补充/转人工/创建工单", 绝不编造 |

### 需求 4: 工具调用与接口适配

| 子项 | 描述 |
|------|------|
| Tool Gateway | 统一管理本地/内网/线上/第三方接口为"工具" |
| 工具定义 | Schema (输入/输出), 权限, 审计, 超时, 重试, 失败回退 |
| 调用模式 | 同步 + 异步两种模式 |
| 流程绑定 | 办事流程每步可绑定工具 (提交申请/查询进度/校验身份/生成清单/创建工单) |

### 需求 5: 合规与兜底

| 子项 | 描述 |
|------|------|
| 全链路 trace_id | 输入/检索命中/引用/模型输出/流程步骤/工具调用参数与结果/转人工原因 全记录 |
| 可回放 | 任意会话可完整回放 |
| 风险控制 | 可配置风险等级/确认点/转人工点/禁止域 |
| 人在回路 | 流程中支持人工介入节点 |
| 敏感信息 | 脱敏存储, 访问权限控制 |

### 需求 6: Headless + 可视化

| 子项 | 描述 |
|------|------|
| Headless API | 统一 `/invoke` API, 任何客户系统可接入 |
| 控制台-Agent管理 | 创建/编辑/启停/版本管理 |
| 控制台-流程配置 | 步骤/字段/校验/提示/工具绑定/兜底点 可视化编排 |
| 控制台-知识管理 | 上传/管理知识源, 检索测试 |
| 控制台-工具管理 | 注册/授权/连通性测试 |
| 控制台-审计面板 | 审计回放, 指标 (延迟/命中率/工具成功率/转人工率/无引用拒答率) |

---

## 三、非功能需求

| 项目 | 要求 |
|------|------|
| 部署 | 支持私有化/本地化部署, Docker + K8s |
| 模型 | 本地模型优先, 支持通义千问/文心/GLM/DeepSeek 等国产模型 |
| 性能 | 快答 <50ms, RAG <200ms, 端到端 <2s |
| 多租户 | 数据隔离, 配置隔离 |
| 可扩展 | 插件机制, 自定义工具, 自定义校验 |
| 国际化 | 主要支持中文, 预留多语言接口 |

---

## 四、技术选型

| 层级 | 选型 | 理由 |
|------|------|------|
| 后端框架 | Python FastAPI | 异步高性能, OpenAPI 原生, AI 生态完善 |
| 前端框架 | React + TypeScript + Ant Design | 企业级 UI 组件, 国内广泛使用 |
| 向量数据库 | FAISS (默认) / Milvus (生产) | FAISS 零依赖开箱用, Milvus 生产级分布式 |
| 关系数据库 | PostgreSQL | 成熟可靠, 支持 JSON 字段 |
| 缓存 | Redis | 快答通道 + 会话缓存 |
| 消息队列 | 可选 RabbitMQ/Redis Stream | 异步工具调用 |
| LLM 适配 | 统一 Adapter 层 | 不绑定厂商, 可切换 |
